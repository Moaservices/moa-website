<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mobile Oil and Auto Services Invoice / Receipt</title>
  <style>
    :root { --border:#d0d7de; --muted:#6b7280; }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #fff;
      color: #111;
    }

    .toolbar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 14px;
    }
    .btn {
      border: 1px solid var(--border);
      background: #f8fafc;
      padding: 10px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    .btn.primary {
      background: #0b5ed7;
      color: #fff;
      border-color: #0b5ed7;
    }
    .btn.danger {
      background: #fff5f5;
      border-color: #fecaca;
    }

    .sheet {
      max-width: 850px;
      margin: 0 auto;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 18px;
    }

    .top {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      align-items: start;
    }

    h1 {
      margin: 0 0 6px 0;
      font-size: 22px;
      color: #d70b0e;
    }

    .muted { color: var(--muted); font-size: 13px; }

    .box {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
    }

    .grid2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    label { display:block; font-weight: bold; font-size: 13px; margin-bottom: 4px; }
    input, textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 9px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 14px;
    }
    textarea { min-height: 70px; resize: vertical; }

    .section-title {
      margin: 16px 0 8px;
      font-size: 15px;
      font-weight: bold;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    th, td {
      border: 1px solid var(--border);
      padding: 8px;
      vertical-align: top;
    }
    th { background: #f8fafc; text-align: left; }
    td.num, th.num { text-align: right; white-space: nowrap; }

    .totals {
      margin-top: 10px;
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 10px;
      align-items: start;
    }

    .totals .box { padding: 12px; }
    .line {
      display:flex;
      justify-content: space-between;
      gap: 12px;
      margin: 6px 0;
      font-size: 14px;
    }
    .line strong { font-size: 15px; }

    .sig-wrap {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

.auth-text {
  margin: 0;
  font-size: 14px;
  line-height: 1.35;
}

    canvas {
      width: 100%;
      height: 140px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: #fff;
      touch-action: none;
    }

    .small { font-size: 12px; color: var(--muted); }

    /* Print styling */
    @media print {
      body { padding: 0; }
      .toolbar { display: none; }
      .sheet { border: none; padding: 0; }
      input, textarea { border: none; padding: 0; }
      .box { border: 1px solid #999; }
      canvas { border: 1px solid #999; }
    }
  </style>
</head>

<body>

  <div class="toolbar">
    <button class="btn" onclick="addLineItem()">+ Add Line Item</button>
    <button class="btn" onclick="clearSignature()">Clear Signature</button>
    <button class="btn" onclick="saveDraft()">Save Draft</button>
    <button class="btn" onclick="loadDraft()">Load Draft</button>
    <button class="btn danger" onclick="clearDraft()">Clear Saved Draft</button>
    <button class="btn primary" onclick="window.print()">Print / Save PDF</button>
  </div>

  <div class="sheet">
    <div class="top">
      <div>
        <h1>Mobile Oil & Auto Services</h1>
        <div class="muted">Mobile service • Oil changes • Light repairs</div>
        <div class="muted" style="margin-top:6px;">
          Phone: <span contenteditable="true">(763) 445-9650</span><br/>
          Email: <span contenteditable="true">your@email.com</span>
        </div>
      </div>

      <div class="box">
        <div class="grid2">
          <div>
            <label>Invoice #</label>
            <input id="invoiceNo" placeholder="MOA-0001" />
          </div>
          <div>
            <label>Date</label>
            <input id="invoiceDate" type="date" />
          </div>
          <div>
            <label>Status</label>
            <input id="status" placeholder="Quote / Final Invoice  / Receipt" />
          </div>
          <div>
            <label>Due</label>
            <input id="due" placeholder="Upon completion" />
          </div>
        </div>
      </div>
    </div>

    <div class="section-title">Customer</div>
    <div class="box">
      <div class="grid2">
        <div>
          <label>Name</label>
          <input id="custName" />
        </div>
        <div>
          <label>Phone</label>
          <input id="custPhone" />
        </div>
        <div>
          <label>Email</label>
          <input id="custEmail" />
        </div>
        <div>
          <label>Service Address</label>
          <input id="custAddress" />
        </div>
      </div>
    </div>

    <div class="section-title">Vehicle</div>
    <div class="box">
      <div class="grid2">
        <div>
          <label>Year / Make / Model</label>
          <input id="vehicle" placeholder="2017 Toyota Camry" />
        </div>
        <div>
          <label>Trim</label>
          <input id="trim" placeholder="SE / XLE / etc." />
        </div>
        <div>
          <label>VIN</label>
          <input id="vin" />
        </div>
        <div>
          <label>Mileage</label>
          <input id="mileage" />
        </div>
      </div>
    </div>

    <div class="section-title">Itemized Work</div>
    <table id="itemsTable">
      <thead>
        <tr>
          <th style="width: 42%;">Description</th>
          <th style="width: 18%;">Parts</th>
          <th style="width: 18%;">Labor</th>
          <th class="num" style="width: 12%;">Qty</th>
          <th class="num" style="width: 10%;">Line Total</th>
        </tr>
      </thead>
      <tbody id="itemsBody">
        <tr>
          <td><input class="parts" placeholder="0.00" inputmode="decimal" /></td>
          <td><input class="labor" placeholder="0.00" inputmode="decimal" /></td>
          <td class="num"><input class="qty" value="1" inputmode="numeric" /></td>
          <td class="num"><span class="lineTotal">$0.00</span> <button class="btn" type="button" onclick="removeRow(this)">Remove</button></td>
        </tr>
      </tbody>
    </table>

    <div class="totals">
<div class="box">
        <label>Notes / Warranty / Terms</label>
        <textarea id="notes" placeholder="Invoice Notes"></textarea>
      </div>

      <div class="box">
        <div class="line"><span>Subtotal</span><span id="subtotal">$0.00</span></div>

        <div class="line">
          <span>Tax %</span>
          <span>
            <input id="taxRate" value="0" inputmode="decimal" style="width:90px; text-align:right;" />
          </span>
        </div>

        <div class="line"><span>Tax</span><span id="taxAmt">$0.00</span></div>

        <div class="line">
          <span>Travel / Service Fee</span>
          <span>
            <input id="fee" value="0" inputmode="decimal" style="width:120px; text-align:right;" />
          </span>
        </div>

        <div class="line"><strong>Total</strong><strong id="total">$0.00</strong></div>

      </div>
    </div>

<div class="section-title">Authorization to Repair & Payment Agreement</div>
<div class="box">
  <p class="auth-text">
    I authorize <strong>Mobile Oil & Auto Services</strong> to perform the services listed on this invoice/estimate.
    I understand that additional repairs may be necessary once the vehicle is inspected and that I will be contacted for
    approval before any additional charges are added. I agree to pay the <strong>Total Amount Due</strong> shown on this invoice
    upon completion of services, unless other arrangements are made in writing. I understand that failure to pay may result
    in collection actions as allowed by law.
  </p>

  <div class="sig-wrap" style="margin-top: 12px;">
    <div>
      <label>Customer Signature</label>
      <canvas id="sig"></canvas>
      <div class="small">Sign with finger/mouse. Use “Clear Signature” if needed.</div>
    </div>
    <div>
      <label>Print Name</label>
      <input id="sigName" placeholder="Customer name" />

      <label style="margin-top:12px;">Approval Date</label>
      <input id="sigDate" type="date" />

      <label style="margin-top:12px;">Technician</label>
      <input id="tech" placeholder="MOA" />
    </div>
  </div>

  <p class="small" style="margin-top: 10px;">
    Note: This authorization applies only to the services and totals listed above at the time of signing.
  </p>
</div>

  </div>

<script>
  // Helpers
  function money(n) {
    const num = isFinite(n) ? n : 0;
    return "$" + num.toFixed(2);
  }
  function parseMoney(val) {
    if (!val) return 0;
    const cleaned = String(val).replace(/[^0-9.-]/g, "");
    const n = parseFloat(cleaned);
    return isFinite(n) ? n : 0;
  }

  // Auto dates
  const today = new Date();
  const iso = today.toISOString().slice(0,10);
  document.getElementById("invoiceDate").value = iso;
  document.getElementById("sigDate").value = iso;

  // Line item calculations
  function recalc() {
    const rows = document.querySelectorAll("#itemsBody tr");
    let subtotal = 0;

    rows.forEach(row => {
      const parts = parseMoney(row.querySelector(".parts").value);
      const labor = parseMoney(row.querySelector(".labor").value);
      const qty = parseFloat(row.querySelector(".qty").value) || 0;

      const line = (parts + labor) * qty;
      row.querySelector(".lineTotal").textContent = money(line);
      subtotal += line;
    });

    const taxRate = parseMoney(document.getElementById("taxRate").value) / 100;
    const fee = parseMoney(document.getElementById("fee").value);

    const taxAmt = subtotal * taxRate;
    const total = subtotal + taxAmt + fee;

    document.getElementById("subtotal").textContent = money(subtotal);
    document.getElementById("taxAmt").textContent = money(taxAmt);
    document.getElementById("total").textContent = money(total);
  }

  document.addEventListener("input", (e) => {
    if (
      e.target.classList.contains("parts") ||
      e.target.classList.contains("labor") ||
      e.target.classList.contains("qty") ||
      e.target.id === "taxRate" ||
      e.target.id === "fee"
    ) {
      recalc();
    }
  });

  function addLineItem() {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input class="desc" placeholder="Service description" /></td>
      <td><input class="parts" placeholder="0.00" inputmode="decimal" /></td>
      <td><input class="labor" placeholder="0.00" inputmode="decimal" /></td>
      <td class="num"><input class="qty" value="1" inputmode="numeric" /></td>
      <td class="num"><span class="lineTotal">$0.00</span> <button class="btn" type="button" onclick="removeRow(this)">Remove</button></td>
    `;
    document.getElementById("itemsBody").appendChild(tr);
    recalc();
  }

  function removeRow(btn) {
    const row = btn.closest("tr");
    row.remove();
    recalc();
  }

  // Signature pad (simple)
  const canvas = document.getElementById("sig");
  const ctx = canvas.getContext("2d");
  let drawing = false;

  function resizeCanvas() {
    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    canvas.width = Math.floor(rect.width * dpr);
    canvas.height = Math.floor(rect.height * dpr);
    ctx.scale(dpr, dpr);
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#111";
  }
  window.addEventListener("resize", () => {
    // Reset and resize; note: signature will clear on resize
    ctx.setTransform(1,0,0,1,0,0);
    resizeCanvas();
  });
  resizeCanvas();

  function getPos(e) {
    const rect = canvas.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    return { x: clientX - rect.left, y: clientY - rect.top };
  }

  function startDraw(e) {
    drawing = true;
    const p = getPos(e);
    ctx.beginPath();
    ctx.moveTo(p.x, p.y);
    e.preventDefault();
  }

  function draw(e) {
    if (!drawing) return;
    const p = getPos(e);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
    e.preventDefault();
  }

  function endDraw(e) {
    drawing = false;
    e.preventDefault();
  }

  canvas.addEventListener("mousedown", startDraw);
  canvas.addEventListener("mousemove", draw);
  window.addEventListener("mouseup", endDraw);

  canvas.addEventListener("touchstart", startDraw, { passive: false });
  canvas.addEventListener("touchmove", draw, { passive: false });
  window.addEventListener("touchend", endDraw, { passive: false });

  function clearSignature() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }

  // Save/Load draft to browser (per device)
  function saveDraft() {
    const data = {
      invoiceNo: v("invoiceNo"),
      invoiceDate: v("invoiceDate"),
      status: v("status"),
      due: v("due"),
      custName: v("custName"),
      custPhone: v("custPhone"),
      custEmail: v("custEmail"),
      custAddress: v("custAddress"),
      vehicle: v("vehicle"),
      trim: v("trim"),
      vin: v("vin"),
      mileage: v("mileage"),
      notes: v("notes"),
      taxRate: v("taxRate"),
      fee: v("fee"),
      sigName: v("sigName"),
      sigDate: v("sigDate"),
      tech: v("tech"),
      items: Array.from(document.querySelectorAll("#itemsBody tr")).map(row => ({
        desc: row.querySelector(".desc").value,
        parts: row.querySelector(".parts").value,
        labor: row.querySelector(".labor").value,
        qty: row.querySelector(".qty").value
      })),
      sig: canvas.toDataURL("image/png")
    };
    localStorage.setItem("moa_invoice_draft", JSON.stringify(data));
    alert("Draft saved on this device.");
  }

  function loadDraft() {
    const raw = localStorage.getItem("moa_invoice_draft");
    if (!raw) { alert("No saved draft found on this device."); return; }
    const data = JSON.parse(raw);

    set("invoiceNo", data.invoiceNo);
    set("invoiceDate", data.invoiceDate);
    set("status", data.status);
    set("due", data.due);

    set("custName", data.custName);
    set("custPhone", data.custPhone);
    set("custEmail", data.custEmail);
    set("custAddress", data.custAddress);

    set("vehicle", data.vehicle);
    set("trim", data.trim);
    set("vin", data.vin);
    set("mileage", data.mileage);

    set("notes", data.notes);
    set("taxRate", data.taxRate);
    set("fee", data.fee);

    set("sigName", data.sigName);
    set("sigDate", data.sigDate);
    set("tech", data.tech);

    // Rebuild items
    const body = document.getElementById("itemsBody");
    body.innerHTML = "";
    data.items.forEach(it => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input class="desc" placeholder="Service description" /></td>
        <td><input class="parts" placeholder="0.00" inputmode="decimal" /></td>
        <td><input class="labor" placeholder="0.00" inputmode="decimal" /></td>
        <td class="num"><input class="qty" value="1" inputmode="numeric" /></td>
        <td class="num"><span class="lineTotal">$0.00</span> <button class="btn" type="button" onclick="removeRow(this)">Remove</button></td>
      `;
      tr.querySelector(".desc").value = it.desc || "";
      tr.querySelector(".parts").value = it.parts || "";
      tr.querySelector(".labor").value = it.labor || "";
      tr.querySelector(".qty").value = it.qty || "1";
      body.appendChild(tr);
    });

    // Restore signature image
    if (data.sig) {
      const img = new Image();
      img.onload = () => {
        clearSignature();
        // draw image scaled to canvas css size
        const rect = canvas.getBoundingClientRect();
        ctx.drawImage(img, 0, 0, rect.width, rect.height);
      };
      img.src = data.sig;
    }

    recalc();
    alert("Draft loaded.");
  }

  function clearDraft() {
    localStorage.removeItem("moa_invoice_draft");
    alert("Saved draft cleared.");
  }

  function v(id) { return document.getElementById(id).value; }
  function set(id, val) { document.getElementById(id).value = val || ""; }

  // Initial calc
recalc();
</script>

</body>
</html>
